# Patch Utils Script

The patch utils script offers commands to assist in developing a patch when provided with a base json file defining the semantics for basic blocks as generated by `irene-codegen`. Developing a patch to decompilation in this manner allows IRENE to fill in context for a patch, including patch variable locations and liveness.

All sub-commands take the `codegen.json` as the first argument ie.
`python3 patch_utils.py <path>.json <subcommand>`

## Intended Workflow

### Render the CFG Decompilation with Graphviz

The `render` subcommand allows you to view a codegen.json file as a CFG of C decompilation. The help message is:

```
usage: patch_utils.py target_json render [-h] [--format FORMAT] [--view] [--apply-patches APPLY_PATCHES] output_file
```

The output file argument is a path where the rendered CFG will be written. The format can be changed from Graphviz's default with `--format <intended format>`, supported formats are listed [here](https://graphviz.org/docs/outputs/). `--view` attempts to automatically open the render in a suitable viewer.

Example: `python3 patch_utils.py /tmp/patches.json render --view /tmp/out.dot`

Will read the codegen.json `/tmp/patches.json` write an `out.dot` and view it as a pdf.

## Extract a Block to Patch

The `extract_subprogram` sub-command creates a C file that can be edited in order to patch the target block.

```
usage: patch_utils.py target_json extract_subprogram [-h] target_block_id output_file

positional arguments:
  target_block_id  the address id of the block to extract
  output_file      the file to write the C to

options:
  -h, --help       show this help message and exit
```

The `target_block_id` is the address of the block you wish to edit. In the rendered CFG view the ID will be printed above each block. The `output_file` is where to write the C code for editing. 

Example: `python3 patch_utils.py /tmp/patches.json extract_subprogram 0x140f8 /tmp/to-edit.c`

Extract block `0x140f8` for editing into `to-edit.c`

At this point you can edit the C in this file to your desired block semantics.

## Add the Developed Patch to the Patch List

The `patch_subprogram` sub-command takes a C block definition along with the `codegen.json` and adds this C semantics to a patch list (or creates a new patch list if the provided output file does not exist).

```
usage: patch_utils.py target_json patch_subprogram [-h] target_block_id input_c output_file

positional arguments:
  target_block_id  the address id of the block to extract
  input_c          the new C semantics for this block
  output_file      the patch definition file

options:
  -h, --help       show this help message and exit
```



`target_json` is the codegen json providing semantics for all blocks in the function. The `target_block_id` is the block that should be patched with the provided C semantics in `input_c`. The `target_block_id` should generally be the address that was extracted via `extract_subprogram` unless you are developing a patch from scratch. The `output_file` is the path to a json file to add this patch to. The patch list will be created if `output_file` does not exist.

Example: `python3 patch_utils.py /tmp/patches.json patch_subprogram 0x140f8 /tmp/to-edit.c /tmp/new_patch_list.json`

Produces or adds a patch to `new_patch_list.json` where the block at `0x140f8` in the function defined by the codegen json `/tmp/patches.json` is replaced with the C semantics in `/tmp/to-edit.c`.

The process of extracting, editing and applying patches to a patch list can be repeated until your patch list contains all the desired block patches for the target function.

## View the Effect of the Patch List

After developing your patch list the effect of these patches can be viewed in the CFG view by adding the `--apply-patches` argument to the `render` sub-command. This argument takes a patch list and will show the function CFG with the blocks replaced by patches defined in the patch list.

Example: `python3 patch_utils.py /tmp/patches.json render --view /tmp/patched_out.dot --apply-patches /tmp/new_patch_list.json`

Renders the function CFG from `patches.json` into a dot file `patched_out.dot` with the patch list developed in `/tmp/new_patch_list.json` and attempts to open a PDF viewer.

## Pass Patch Definition on to TA2

Now that a list of patch definitions has been developed and viewed these patches are ready to be situated into the target binary by TA2.